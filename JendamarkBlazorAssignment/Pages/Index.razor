@page "/"
@using JendamarkBlazorAssignment.Data
@using JendamarkBlazorAssignment.Models;
@using JendamarkBlazorAssignment.Components;
@using System.IO;
@using System.Text;
@inject OperationService Service

<table class="table">
    <thead>
        <tr>
            <th></th>
            <th>Operation ID</th>
            <th>Name</th>
            <th>Order in which to perform</th>
            <th>Image</th>
            <th>Device ID</th>
            <th>Device Name</th>
            <th>Device Type</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var operation in operations)
        {
            <tr>
                <td>
                    <button class="btn btn-primary" @onclick="@(() => AddNewOperation())">Add</button>
                    <button class="btn btn-primary" @onclick="@(() => Remove(operation.OperationID))">Remove</button>
                </td>

                <td>@operation.OperationID</td>
                <td>@operation.Name</td>
                <td>@operation.OrderInWhichToPerform</td>
                <td><img src="@operation.ImageDataUrl" width="30" height="30" /></td>
                <td>@operation.Device.DeviceID</td>
                <td>@operation.Device.Name</td>
                <td>@operation.Device.DeviceType</td>
            </tr>
        }
    </tbody>
</table>


@code {
    private Operation[] operations;

    [CascadingParameter] public IModalService Modal { get; set; }

    protected override async Task OnInitializedAsync()
    {
        operations = await Service.GetOperationAsync();
    }

    void Remove(Guid operationId)
    {
        operations = operations.Where(x => x.OperationID != operationId).ToArray();
    }

    async Task AddNewOperation()
    {
        var options = new ModalOptions()
        {
            Animation = ModalAnimation.FadeInOut(1),
            HideCloseButton = true,
            Class = "blazored-modal-movies"
        };

        var formModel = Modal.Show<AddOperationComponent>("Add Operation");
        var result = await formModel.Result;

        if (result.Cancelled)
        {
            Console.WriteLine("Modal was cancelled");
        }
        else
        {
            ModalParameters resultModel = result.Data as ModalParameters;

            var name = resultModel.TryGet<string>("Name");
            var order = resultModel.TryGet<string>("Order");
            var image = resultModel.TryGet<byte[]>("Image");

            if (image is not null)
            {
                CreateNewOperation(name, Convert.ToInt32(order), image);
            }
            else
            {
                CreateNewOperation(name, Convert.ToInt32(order), null);
            }

        }

        void CreateNewOperation(string name, int order, byte[] image)
        {
            List<Operation> list = new List<Operation>();

            foreach (var item in operations)
            {
                list.Add(item);
            }

            list.Add(new Operation
            {
                Name = name,
                OrderInWhichToPerform = order,
                ImageDataUrl = string.Format("data:image/jpeg;base64,{0}", Convert.ToBase64String(image)),
                OperationID = Guid.NewGuid(),
                Device = new Device() { Name = "Added Device", DeviceID = Guid.NewGuid(), DeviceType = DeviceType.Printer },
            });

            list = list.OrderBy(x => x.OrderInWhichToPerform).ToList();

            operations = list.ToArray();
        }
    }
}